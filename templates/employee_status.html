{% extends 'base.html' %}
{% block title %}Ficha de {{ user.full_name or user.username }}{% endblock %}
{% block header %}
  <span class="text-timetracker-primary">
    Ficha de {{ user.full_name or user.username }}
  </span>
{% endblock %}

{% block extra_head %}
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.17/locales-all.global.min.js"></script>
{% endblock %}

{% block content %}
<div class="bg-gray-900 border border-gray-700 rounded-lg shadow-md p-8">

  <!-- ----------  BOTÓN ATRÁS ---------- -->
  <div class="mb-4 flex">
    <a href="{{ url_for('admin.admin_calendar') }}" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-white">← Volver al calendario</a>
  </div>

  <!-- ----------  FORMULARIO NUEVO RANGO  ---------- -->
  <form method="POST" class="grid md:grid-cols-5 gap-4 mb-8">
    <div>
      <label class="block text-sm text-gray-300 mb-1">Fecha inicio *</label>
      <input type="date" name="start_date" required
             class="w-full px-2 py-1 bg-gray-800 border border-gray-600 rounded text-gray-100">
    </div>

    <div>
      <label class="block text-sm text-gray-300 mb-1">Fecha final</label>
      <input type="date" name="end_date"
             class="w-full px-2 py-1 bg-gray-800 border border-gray-600 rounded text-gray-100">
    </div>

    <div>
      <label class="block text-sm text-gray-300 mb-1">Estado</label>
      <select name="status"
              class="w-full px-2 py-1 bg-gray-800 border border-gray-600 rounded text-gray-100">
        <option value="">Todo</option>
        <option>Trabajado</option>
        <option>Baja</option>
        <option>Ausente</option>
        <option>Vacaciones</option>
      </select>
    </div>

    <div class="md:col-span-2">
      <label class="block text-sm text-gray-300 mb-1">Notas Admin</label>
      <input type="text" name="admin_notes" value=""
             autocomplete="off"
             class="w-full px-2 py-1 bg-gray-800 border border-gray-600 rounded text-gray-100"
             placeholder="Ingrese notas de administrador (opcional)">
    </div>

    <div class="md:col-span-5 flex justify-end gap-2">
      <button type="button" id="reset-filters"
              class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded text-white">
        Limpiar
      </button>
      <button type="button" id="filter-calendar"
              class="px-6 py-2 rounded text-white transition-all hover:opacity-90"
              style="background-color: var(--accent-primary);">
        Filtrar
      </button>
      <button type="submit" class="px-6 py-2 rounded text-white transition-all hover:opacity-90" style="background-color: var(--accent-primary);">
        Añadir
      </button>
    </div>
  </form>

  <!-- ----------  CALENDARIO PERSONAL  ---------- -->
  <div class="w-full">
    <div id="user-calendar"></div>
  </div>

  <!-- ----------  MODAL DE EDICIÓN  ---------- -->
  <div id="editModal" class="fixed inset-0 z-50 flex items-center justify-center hidden" style="background:rgba(0,0,0,0.5);">
    <div class="bg-gray-900 rounded-lg shadow-lg p-8 w-full max-w-md relative">
      <h3 class="text-lg font-bold text-gray-100 mb-4">Editar estado</h3>
      <form id="editStatusForm" method="POST">
        <input type="hidden" name="edit_status_id" id="edit_status_id">
        <div class="mb-4">
          <label class="block text-sm text-gray-300 mb-1">Fecha</label>
          <input type="text" id="edit_date" name="edit_date" readonly class="w-full px-2 py-1 bg-gray-800 border border-gray-600 rounded text-gray-100">
        </div>
        <div class="mb-4">
          <label class="block text-sm text-gray-300 mb-1">Estado</label>
          <select id="edit_status" name="edit_status" class="w-full px-2 py-1 bg-gray-800 border border-gray-600 rounded text-gray-100">
            <option value=""></option>
            <option value="Trabajado">Trabajado</option>
            <option value="Baja">Baja</option>
            <option value="Ausente">Ausente</option>
            <option value="Vacaciones">Vacaciones</option>
          </select>
        </div>
        <!-- Nueva fila: Entrada / Salida -->
        <div class="mb-4 grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm text-gray-300 mb-1">Entrada</label>
            <input type="time" id="edit_check_in" name="edit_check_in" class="w-full px-2 py-1 bg-gray-800 border border-gray-600 rounded text-gray-100" placeholder="HH:MM">
          </div>
          <div>
            <label class="block text-sm text-gray-300 mb-1">Salida</label>
            <input type="time" id="edit_check_out" name="edit_check_out" class="w-full px-2 py-1 bg-gray-800 border border-gray-600 rounded text-gray-100" placeholder="HH:MM">
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-gray-300 mb-1">Notas Admin</label>
          <input type="text" id="edit_admin_notes" name="admin_notes" class="w-full px-2 py-1 bg-gray-800 border border-gray-600 rounded text-gray-100">
        </div>
        <div class="flex justify-between mt-6">
          <button type="button" id="closeModalBtn" class="bg-gray-700 hover:bg-gray-800 px-4 py-2 rounded text-white">Cancelar</button>
          <button type="submit" class="px-4 py-2 rounded text-white transition-all hover:opacity-90" style="background-color: var(--accent-primary);">Guardar cambios</button>
          <form method="POST" id="deleteForm" style="display:inline;">
            <button type="button" id="deleteBtn" class="bg-red-700 hover:bg-red-800 px-4 py-2 rounded text-white">Eliminar</button>
          </form>
        </div>
      </form>
    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---------- LIMPIAR CAMPOS AL CARGAR ----------
  // Asegurar que el campo de notas admin esté vacío al cargar la página
  const adminNotesInput = document.querySelector('input[name="admin_notes"]');
  if (adminNotesInput) {
    adminNotesInput.value = '';
  }

  // ---------- VARIABLES GLOBALES ----------
  let dateFilters = {};
  let statusFilter = '';

  // ---------- FULLCALENDAR ----------
  const cal = new FullCalendar.Calendar(document.getElementById('user-calendar'), {
    initialView : 'dayGridMonth',
    firstDay    : 1,
    locale      : 'es',
    height      : 'auto',
    dayMaxEvents: 3,
    eventDisplay: 'block',

    events(info, success, fail) {
      // Construir parámetros base
      const params = {
        user_id: '{{ user.id }}',
        start: dateFilters.start || info.startStr,
        end: dateFilters.end || info.endStr
      };

      fetch(`/admin/api/events?${new URLSearchParams(params).toString()}`)
        .then(r => r.json())
        .then(events => {
          // Filtrar por estado si se seleccionó uno específico
          if (statusFilter && statusFilter !== '') {
            const filtered = events.filter(ev => {
              const evStatus = ev.extendedProps?.filterStatus || ev.title.split(' - ')[0];
              return evStatus === statusFilter;
            });
            success(filtered);
          } else {
            success(events);
          }
        })
        .catch(fail);
    },

    eventClick(info) {
      // Mostrar modal de edición
      const modal = document.getElementById('editModal');
      modal.classList.remove('hidden');
      const props = info.event.extendedProps || {};
      document.getElementById('edit_status_id').value = info.event.id;
      // Mostrar la fecha en formato día/mes/año
      try {
        const d = info.event.start instanceof Date ? info.event.start : new Date(info.event.startStr);
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yyyy = d.getFullYear();
        document.getElementById('edit_date').value = `${dd}/${mm}/${yyyy}`;
      } catch (e) {
        // Fallback por si algo falla
        document.getElementById('edit_date').value = info.event.startStr;
      }
      document.getElementById('edit_status').value = info.event.title.split(' - ')[0];
      // Prefill Entrada/Salida si existen en extendedProps
      document.getElementById('edit_check_in').value = (props.check_in_time || '').slice(0,5);
      document.getElementById('edit_check_out').value = (props.check_out_time || '').slice(0,5);
      // Mostrar las notas del admin (no las del empleado)
      document.getElementById('edit_admin_notes').value = props.admin_notes || '';

      // Delete (enviar POST)
      document.getElementById('deleteBtn').onclick = function() {
        if (confirm('¿Eliminar este estado?')) {
          fetch(`/admin/employees/{{ user.id }}/status/delete/${info.event.id}`, {method: 'POST'})
            .then(() => window.location.reload());
        }
      };
    }
  });
  cal.render();

  // ---------- VALIDACIÓN DEL FORMULARIO DE AÑADIR ----------
  const form = document.querySelector('form[method="POST"]');

  form.addEventListener('submit', e => {
    const status = form.status.value;
    if (!status || status === '') {
      e.preventDefault();
      alert('Por favor, selecciona un estado válido (Trabajado, Baja, Ausente o Vacaciones)');
      return false;
    }
  });

  // ---------- MANEJO DEL FILTRADO ----------

  document.getElementById('filter-calendar').addEventListener('click', e => {
    e.preventDefault();

    // Capturar valores del formulario
    const startDate = form.start_date.value;
    const endDate = form.end_date.value;
    const status = form.status.value;

    // Actualizar filtros de fecha solo si tienen valor
    if (startDate || endDate) {
      dateFilters = {
        start: startDate || undefined,
        end: endDate || undefined
      };
    } else {
      dateFilters = {};
    }

    // Actualizar filtro de estado
    statusFilter = status;

    // Recargar eventos
    cal.refetchEvents();
  });

  document.getElementById('reset-filters').addEventListener('click', e => {
    e.preventDefault();

    // Limpiar filtros
    dateFilters = {};
    statusFilter = '';

    // Limpiar campos del formulario
    form.start_date.value = '';
    form.end_date.value = '';
    form.status.value = '';
    form.admin_notes.value = '';  // Limpiar también el campo de notas admin

    // Recargar eventos
    cal.refetchEvents();
  });

  // Cerrar modal
  document.getElementById('closeModalBtn').onclick = function() {
    document.getElementById('editModal').classList.add('hidden');
  };

  // Guardar cambios al editar
  document.getElementById('editStatusForm').onsubmit = function(e) {
    e.preventDefault();
    const status_id = document.getElementById('edit_status_id').value;
    const status = document.getElementById('edit_status').value;
    const admin_notes = document.getElementById('edit_admin_notes').value;
    const check_in = document.getElementById('edit_check_in').value;   // HH:MM
    const check_out = document.getElementById('edit_check_out').value; // HH:MM

    console.log('Editando estado:', { status_id, status, admin_notes });

    // Si el estado está vacío, eliminar el registro en lugar de actualizarlo
    if (!status || status === '') {
      if (confirm('¿Deseas eliminar este estado y dejar el día libre?')) {
        fetch(`/admin/employees/{{ user.id }}/status/delete/${status_id}`, {
          method: 'POST'
        })
        .then(response => {
          console.log('Estado eliminado:', response);
          if (response.ok) {
            window.location.reload();
          } else {
            console.error('Error al eliminar:', response.status);
            alert('Error al eliminar el estado');
          }
        })
        .catch(error => {
          console.error('Error en la petición:', error);
          alert('Error al eliminar el estado');
        });
      }
      return;
    }

    // Si hay estado, actualizar normalmente
    fetch(`/admin/employees/{{ user.id }}/status/edit/${status_id}`, {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({status, admin_notes, check_in, check_out})
    })
    .then(response => {
      console.log('Respuesta del servidor:', response);
      if (response.ok) {
        window.location.reload();
      } else {
        console.error('Error en la respuesta:', response.status);
        alert('Error al guardar los cambios');
      }
    })
    .catch(error => {
      console.error('Error en la petición:', error);
      alert('Error al guardar los cambios');
    });
  };
});
</script>
{% endblock %}
