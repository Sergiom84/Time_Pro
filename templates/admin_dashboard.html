{% extends 'base.html' %}
{% block title %}Dashboard Admin{% endblock %}
{% block header %}<span class="text-timetracker-primary">Panel de Administraci√≥n</span>{% endblock %}

{% block content %}

<section class="bg-gray-800 shadow-md rounded-lg p-6 mb-6">
  <div class="mb-3">
    <span class="font-semibold text-lg text-gray-200">Resumen R√°pido</span>
    <div class="flex flex-row gap-2 mt-2">
      <a href="{{ url_for('admin.dashboard') }}"
         class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md shadow-sm text-white transition-all hover:opacity-90"
         style="background-color: var(--accent-primary);">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Actualizar
      </a>
      <a href="{{ url_for('admin.open_records') }}"
         class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-yellow-600 hover:bg-yellow-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Fichajes abiertos
      </a>
      <button onclick="manualCloseRecords()"
         class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        Cerrar todos ahora
      </button>
      <a href="{{ url_for('admin.leave_requests') }}"
         class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
        </svg>
        Solicitudes
      </a>
      <a href="{{ url_for('admin.work_pauses') }}"
         class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-orange-600 hover:bg-orange-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Pausas
      </a>
      <a href="{{ url_for('admin.overtime_dashboard') }}"
         class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-teal-600 hover:bg-teal-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Gesti√≥n de Horas
      </a>
    </div>
  </div>
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
    <div class="rounded p-4 flex flex-col items-center shadow" style="background-color: var(--accent-dark);">
      <span class="text-3xl font-bold text-white">{{ user_count }}</span>
      <span class="text-xs uppercase tracking-wide text-gray-200 mt-1">Usuarios<br/>registrados</span>
    </div>
    <div class="rounded p-4 flex flex-col items-center shadow" style="background-color: var(--accent-dark);">
      <span class="text-3xl font-bold text-white">{{ active_user_count }}</span>
      <span class="text-xs uppercase tracking-wide text-gray-200 mt-1">Usuarios<br/>activos</span>
    </div>
  </div>

  <!-- Filtros y Notificaciones -->
  <form method="get" action="{{ url_for('admin.dashboard') }}" class="mt-4 grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
    {% if plan_config.show_center_selector %}
    <div>
      <label class="block text-xs text-gray-300 mb-1">{{ plan_config.center_label }}</label>
      <select name="centro" class="w-full px-3 py-2 rounded bg-gray-800 text-gray-200 border border-gray-700">
        <option value="">Todos</option>
        {% for c in centros %}
          <option value="{{ c }}" {{ 'selected' if request.args.get('centro') == c else '' }}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
    <div>
      <label class="block text-xs text-gray-300 mb-1">Categor√≠a</label>
      <select name="categoria" class="w-full px-3 py-2 rounded bg-gray-800 text-gray-200 border border-gray-700">
        <option value="">Todas</option>
        {% for cat in categorias %}
          <option value="{{ cat }}" {{ 'selected' if request.args.get('categoria') == cat else '' }}>{{ cat }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="flex gap-2">
      <button type="submit" class="px-4 py-2 text-white rounded transition-all hover:opacity-90" style="background-color: var(--accent-primary);">Aplicar</button>
      <a href="{{ url_for('admin.dashboard') }}" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Limpiar</a>
    </div>
  </form>
</section>

<section class="bg-gray-900 shadow-md rounded-lg p-6 overflow-hidden">
  <h2 class="font-semibold text-lg mb-3 text-gray-200">√öltimos Registros de Fichaje</h2>

  <div class="overflow-x-auto">
    <table class="min-w-full leading-normal text-sm">
      <thead class="bg-gray-800 text-left text-gray-400 uppercase text-xs">
        <tr>
          <th class="px-3 py-2 border-b border-gray-700">Usuario</th>
          <th class="px-3 py-2 border-b border-gray-700">Fecha</th>
          <th class="px-3 py-2 border-b border-gray-700">Entrada</th>
          <th class="px-3 py-2 border-b border-gray-700">Salida</th>
          <th class="px-3 py-2 border-b border-gray-700">Tiempo Trabajado</th>
          <th class="px-3 py-2 border-b border-gray-700">Estado</th>
          <th class="px-3 py-2 border-b border-gray-700">Horas Restantes</th>
          <th class="px-3 py-2 border-b border-gray-700">Categor√≠a</th>
          {% if plan_config.show_center_selector %}
          <th class="px-3 py-2 border-b border-gray-700">{{ plan_config.center_label }}</th>
          {% endif %}
          <th class="px-3 py-2 border-b border-gray-700">Notas</th>
          <th class="px-3 py-2 border-b border-gray-700">Notas Admin</th>
        </tr>
      </thead>
<tbody class="text-gray-200">
  {% for item in recent_records %}
    <tr class="border-b border-gray-700 hover:bg-gray-800">
      <td class="px-3 py-2 whitespace-nowrap">{{ item.record.user.username }}</td>
      <td class="px-3 py-2 whitespace-nowrap">{{ item.record.date.strftime('%d-%m-%Y') }}</td>
      <td class="px-3 py-2 whitespace-nowrap">
        {{ item.record.check_in.strftime('%H:%M:%S') if item.record.check_in else '-' }}
      </td>
      <td class="px-3 py-2 whitespace-nowrap">
        {% if item.record.check_out %}
          {{ item.record.check_out.strftime('%H:%M:%S') }}
        {% elif item.is_open %}
          <span class="text-yellow-400 font-bold">Pendiente</span>
        {% else %}
          -
        {% endif %}
      </td>
      <td class="px-3 py-2 whitespace-nowrap">
        {{ item.duration_formatted }}
      </td>
      <td class="px-3 py-2 whitespace-nowrap">
        {% if item.active_pause %}
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold"
                style="background-color:
                  {% if item.active_pause.pause_type == 'Descanso' %}#CA8A04
                  {% elif item.active_pause.pause_type == 'Hora del almuerzo' %}#10B981
                  {% elif item.active_pause.pause_type == 'Asuntos m√©dicos' %}#EF4444
                  {% elif item.active_pause.pause_type == 'Desplazamientos' %}#F59E0B
                  {% else %}#8B5CF6{% endif %}; color: white;">
            {{ item.active_pause.pause_type }}
          </span>
        {% elif item.is_open %}
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold" style="background-color: #10B981; color: white;">
            Trabajando
          </span>
        {% else %}
          <span class="text-gray-500">-</span>
        {% endif %}
      </td>
      <td class="px-3 py-2 whitespace-nowrap">
        {% if item.is_over %}
          <span class="text-red-500">‚óè</span> -{{ item.remaining_formatted }}
        {% else %}
          <span class="text-green-500">‚óè</span> {{ item.remaining_formatted }}
        {% endif %}
      </td>
      <td class="px-3 py-2 whitespace-nowrap">
        {{ item.record.user.category.name if item.record.user.category else '-' }}
      </td>
      {% if plan_config.show_center_selector %}
      <td class="px-3 py-2 whitespace-nowrap">
        {{ item.record.user.center.name if item.record.user.center else '-' }}
      </td>
      {% endif %}
      <td class="px-3 py-2">{{ item.record.notes or "" }}</td>
      <td class="px-3 py-2">{{ item.record.admin_notes or "" }}</td>
    </tr>
  {% else %}
    <tr>
      <td colspan="{{ '11' if plan_config.show_center_selector else '10' }}" class="px-3 py-3 border-b border-gray-700 text-center text-gray-500">
        No hay registros recientes.
      </td>
    </tr>
  {% endfor %}
</tbody>
    </table>
  </div>
</section>

<!-- Modal de Notificaciones -->
<!-- Popup autom√°tico de solicitudes pendientes -->
<div id="pendingRequestsPopup" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
  <div class="popup-slide-in rounded-2xl p-8 max-w-5xl w-full max-h-[85vh] overflow-y-auto" style="background-color: var(--bg-card); border: 2px solid var(--border-color); box-shadow: var(--shadow-lg);">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h3 class="text-2xl font-bold" style="color: var(--accent-primary);">üîî Nuevas Solicitudes Pendientes</h3>
        <p class="text-sm mt-1" style="color: var(--text-muted);">Tienes solicitudes que requieren tu atenci√≥n</p>
      </div>
      <button onclick="closePendingRequestsPopup()" class="text-2xl hover:opacity-70 transition-opacity" style="color: var(--text-primary);">&times;</button>
    </div>

    <div id="pendingRequestsContent" class="space-y-6">
      <!-- Secci√≥n de Vacaciones -->
      <div id="vacacionesSection" class="hidden">
        <div class="flex items-center gap-2 mb-3">
          <div class="w-1 h-6 rounded" style="background-color: #3B82F6;"></div>
          <h4 class="text-lg font-semibold" style="color: var(--text-primary);">üèñÔ∏è Vacaciones (<span id="vacacionesCount">0</span>)</h4>
        </div>
        <div id="vacacionesList" class="space-y-2 ml-4"></div>
      </div>

      <!-- Secci√≥n de Bajas M√©dicas -->
      <div id="bajasSection" class="hidden">
        <div class="flex items-center gap-2 mb-3">
          <div class="w-1 h-6 rounded" style="background-color: #EF4444;"></div>
          <h4 class="text-lg font-semibold" style="color: var(--text-primary);">üè• Bajas M√©dicas (<span id="bajasCount">0</span>)</h4>
        </div>
        <div id="bajasList" class="space-y-2 ml-4"></div>
      </div>

      <!-- Secci√≥n de Ausencias -->
      <div id="ausenciasSection" class="hidden">
        <div class="flex items-center gap-2 mb-3">
          <div class="w-1 h-6 rounded" style="background-color: #F59E0B;"></div>
          <h4 class="text-lg font-semibold" style="color: var(--text-primary);">‚ö†Ô∏è Ausencias (<span id="ausenciasCount">0</span>)</h4>
        </div>
        <div id="ausenciasList" class="space-y-2 ml-4"></div>
      </div>

      <!-- Mensaje si no hay solicitudes -->
      <div id="noRequestsMessage" class="text-center py-8">
        <p class="text-lg" style="color: var(--text-muted);">No hay solicitudes pendientes</p>
      </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div class="flex justify-between items-center mt-8 pt-6 border-t" style="border-color: var(--border-color);">
      <button onclick="hidePopupUntilTomorrow()" class="px-4 py-2 rounded text-sm font-medium transition-all" style="background-color: var(--bg-hover); color: var(--text-primary);">
        No mostrar hasta ma√±ana
      </button>
      <div class="flex gap-3">
        <button onclick="closePendingRequestsPopup()" class="px-6 py-2 rounded font-medium transition-all" style="background-color: var(--bg-hover); color: var(--text-primary);">
          Cerrar
        </button>
        <a href="/admin/leave_requests" class="px-6 py-2 rounded font-medium text-white transition-all hover:opacity-90" style="background-color: var(--accent-primary);">
          Ver todas las solicitudes
        </a>
      </div>
    </div>
  </div>
</div>

<div id="notificationsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="rounded-2xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto" style="background-color: var(--bg-card); border: 2px solid var(--border-color); box-shadow: var(--shadow-lg);">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold" style="color: var(--accent-primary);">Notificaciones de Bajas y Ausencias</h3>
      <button onclick="closeNotificationsModal()" class="text-2xl hover:opacity-70" style="color: var(--text-primary);">&times;</button>
    </div>

    <div id="notificationsList" class="space-y-3">
      <!-- Las notificaciones se cargar√°n din√°micamente aqu√≠ -->
    </div>
  </div>
</div>

<script>
  // === MANEJO DEL MODAL DE NOTIFICACIONES ===
  const notificationsBtn = document.getElementById('headerNotificationsBtn');
  const notificationsModal = document.getElementById('notificationsModal');
  const notificationBadge = document.getElementById('headerNotificationBadge');

  // Abrir modal de notificaciones
  if (notificationsBtn) {
    notificationsBtn.addEventListener('click', (e) => {
      e.preventDefault();
      notificationsModal.classList.remove('hidden');
      loadNotifications();
      // Marcar notificaciones como vistas y ocultar el badge
      notificationsSeen = true;
      if (notificationBadge) {
        notificationBadge.classList.add('hidden');
      }
    });
  }

  // Cerrar modal
  function closeNotificationsModal() {
    notificationsModal.classList.add('hidden');
  }

  // Cargar notificaciones
  async function loadNotifications() {
    try {
      // Cargar SOLO solicitudes pendientes
      const response = await fetch('/admin/notifications/pending-requests');
      const pendingData = await response.json();

      const notificationsList = document.getElementById('notificationsList');

      // Funci√≥n auxiliar para crear HTML de notificaci√≥n con botones de acci√≥n
      function createNotificationHTML(notif) {
        const typeColors = {
          'Vacaciones': '#3B82F6',
          'Baja m√©dica': '#EF4444',
          'Ausencia justificada': '#F59E0B',
          'Ausencia injustificada': '#DC2626',
          'Permiso especial': '#8B5CF6'
        };
        const color = typeColors[notif.request_type] || '#6B7280';

        return `
          <div class="p-5 rounded-lg mb-4 border-l-4" style="background-color: var(--bg-secondary); border-left-color: ${color};">
            <!-- Cabecera con info del empleado -->
            <div class="flex justify-between items-start mb-3">
              <div>
                <h4 class="font-bold text-lg" style="color: var(--text-primary);">${notif.employee_name}</h4>
                <span class="text-xs px-2 py-1 rounded-full text-white mt-1 inline-block" style="background-color: ${color};">
                  ${notif.request_type}
                </span>
              </div>
              <span class="text-xs" style="color: var(--text-muted);">${notif.created_at}</span>
            </div>

            <!-- Info de la solicitud -->
            <div class="grid grid-cols-2 gap-2 text-sm mb-3 p-3 rounded" style="background-color: var(--bg-primary);">
              <p style="color: var(--text-secondary);"><strong style="color: var(--text-primary);">Desde:</strong> ${notif.start_date}</p>
              <p style="color: var(--text-secondary);"><strong style="color: var(--text-primary);">Hasta:</strong> ${notif.end_date}</p>
              <p style="color: var(--text-secondary);" class="col-span-2"><strong style="color: var(--text-primary);">D√≠as:</strong> ${notif.days_count} d√≠a${notif.days_count > 1 ? 's' : ''}</p>
            </div>

            <!-- Motivo -->
            ${notif.reason ? `
              <div class="mb-3 p-3 rounded" style="background-color: var(--bg-primary);">
                <p class="text-sm" style="color: var(--text-secondary);">
                  <strong style="color: var(--accent-primary);">Motivo:</strong> ${notif.reason}
                </p>
              </div>
            ` : ''}

            <!-- Adjunto (si existe) -->
            ${notif.has_attachment ? `
              <div class="mb-3">
                <button onclick="viewNotificationAttachment('${notif.attachment_url}', '${notif.attachment_filename}', 'application/pdf')"
                        class="text-sm px-3 py-2 rounded transition-all hover:opacity-80 inline-flex items-center gap-2"
                        style="background-color: var(--accent-primary); color: white;">
                  üìé Ver Justificante
                </button>
              </div>
            ` : ''}

            <!-- Botones de Acci√≥n -->
            <div class="flex gap-2 mt-4">
              <button onclick="approveRequest(${notif.id})"
                      class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all hover:opacity-90"
                      style="background-color: #10B981; color: white;">
                ‚úì Aprobar
              </button>
              <button onclick="rejectRequest(${notif.id})"
                      class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all hover:opacity-90"
                      style="background-color: #EF4444; color: white;">
                ‚úó Rechazar
              </button>
              <button onclick="closeNotificationsModal()"
                      class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all hover:opacity-90"
                      style="background-color: var(--bg-hover); color: var(--text-primary); border: 1px solid var(--border-color);">
                ‚è± M√°s tarde
              </button>
            </div>
          </div>
        `;
      }

      // Recolectar todas las solicitudes pendientes
      let allRequests = [];

      if (pendingData.success) {
        // Vacaciones pendientes
        if (pendingData.vacaciones && pendingData.vacaciones.length > 0) {
          allRequests = allRequests.concat(pendingData.vacaciones);
        }
        // Bajas pendientes
        if (pendingData.bajas && pendingData.bajas.length > 0) {
          allRequests = allRequests.concat(pendingData.bajas);
        }
        // Ausencias pendientes
        if (pendingData.ausencias && pendingData.ausencias.length > 0) {
          allRequests = allRequests.concat(pendingData.ausencias);
        }
      }

      // Ordenar por fecha: m√°s recientes primero
      allRequests.sort((a, b) => {
        const dateA = new Date(a.created_at.split('/').reverse().join('-') + ' ' + a.created_at.split(' ')[1]);
        const dateB = new Date(b.created_at.split('/').reverse().join('-') + ' ' + b.created_at.split(' ')[1]);
        return dateB - dateA; // Descendente (m√°s recientes primero)
      });

      // Mostrar todas las solicitudes pendientes
      if (allRequests.length > 0) {
        notificationsList.innerHTML = allRequests.map(req => createNotificationHTML(req)).join('');
      } else {
        notificationsList.innerHTML = `
          <div class="text-center py-8" style="color: var(--text-secondary);">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p>No hay notificaciones recientes</p>
          </div>
        `;
      }
    } catch (error) {
      console.error('Error al cargar notificaciones:', error);
      document.getElementById('notificationsList').innerHTML = `
        <div class="text-center py-8 text-red-500">
          <p>Error al cargar las notificaciones</p>
        </div>
      `;
    }
  }

  // Variable para controlar si el usuario ya vio las notificaciones
  let notificationsSeen = false;

  // Actualizar badge de notificaciones
  function updateNotificationBadge(count) {
    // Solo mostrar badge si hay notificaciones y el usuario no las ha visto a√∫n
    if (count > 0 && !notificationsSeen) {
      if (notificationBadge) {
        notificationBadge.textContent = count > 9 ? '9+' : count;
        notificationBadge.classList.remove('hidden');
        // A√±adir animaci√≥n de pulso
        notificationBadge.classList.add('notification-pulse');
      }
    } else {
      if (notificationBadge) {
        notificationBadge.classList.add('hidden');
        notificationBadge.classList.remove('notification-pulse');
      }
    }
  }

  // Cargar contador de notificaciones al cargar la p√°gina
  async function loadNotificationCount() {
    try {
      // Obtener SOLO solicitudes pendientes (no auto-aprobadas)
      const response = await fetch('/admin/notifications/pending-requests');
      const pendingData = await response.json();

      let totalCount = 0;

      // Contar solo solicitudes pendientes
      if (pendingData.success) {
        totalCount = pendingData.total;
      }

      updateNotificationBadge(totalCount);
    } catch (error) {
      console.error('Error al cargar contador de notificaciones:', error);
    }
  }

  // Cargar al iniciar
  window.addEventListener('load', loadNotificationCount);

  // Actualizar cada 60 segundos (solo si no han sido vistas)
  setInterval(() => {
    if (!notificationsSeen) {
      loadNotificationCount();
    }
  }, 60000);

  // Funci√≥n para visualizar adjuntos desde notificaciones
  function viewNotificationAttachment(url, filename, mimeType) {
    // Crear modal si no existe
    let modal = document.getElementById('attachmentModalNotif');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'attachmentModalNotif';
      modal.className = 'hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto" style="background-color: var(--bg-card); border: 2px solid var(--border-color); box-shadow: var(--shadow-lg);">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold" style="color: var(--accent-primary);">Justificante</h3>
            <button onclick="document.getElementById('attachmentModalNotif').classList.add('hidden')" class="text-2xl hover:opacity-70" style="color: var(--text-primary);">&times;</button>
          </div>
          <div id="attachmentContentNotif" class="text-center"></div>
          <div class="flex gap-3 mt-6">
            <a id="downloadLinkNotif" href="#" download class="flex-1 px-6 py-3 rounded-full font-semibold text-center transition-all hover:opacity-80" style="background-color: var(--accent-primary); color: white;">
              ‚¨áÔ∏è Descargar
            </a>
            <button onclick="document.getElementById('attachmentModalNotif').classList.add('hidden')" class="flex-1 px-6 py-3 rounded-full font-semibold transition-all hover:opacity-80" style="background-color: var(--bg-secondary); color: var(--text-primary); border: 2px solid var(--border-color);">
              Cerrar
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    const content = document.getElementById('attachmentContentNotif');
    const downloadLink = document.getElementById('downloadLinkNotif');

    // Configurar descarga
    downloadLink.href = url;
    downloadLink.download = filename;

    // Mostrar contenido
    if (mimeType && mimeType.includes('pdf')) {
      content.innerHTML = `<embed src="${url}" type="application/pdf" width="100%" height="600px" class="rounded-lg" />`;
    } else if (mimeType && mimeType.includes('image')) {
      content.innerHTML = `<img src="${url}" alt="${filename}" class="max-w-full max-h-[600px] mx-auto rounded-lg shadow-lg" />`;
    } else {
      content.innerHTML = `
        <div class="text-gray-400">
          <p>Archivo: <strong style="color: var(--text-primary);">${filename}</strong></p>
          <p class="mt-4">Usa el bot√≥n "Descargar" para ver el archivo</p>
        </div>
      `;
    }

    modal.classList.remove('hidden');
  }

  // === POPUP AUTOM√ÅTICO DE SOLICITUDES PENDIENTES ===

  const pendingRequestsPopup = document.getElementById('pendingRequestsPopup');

  // Funci√≥n para cargar solicitudes pendientes
  async function loadPendingRequests() {
    try {
      const response = await fetch('/admin/notifications/pending-requests');
      const data = await response.json();

      if (data.success && data.total > 0) {
        renderPendingRequests(data);
        return data.total;
      }
      return 0;
    } catch (error) {
      console.error('Error al cargar solicitudes pendientes:', error);
      return 0;
    }
  }

  // Renderizar solicitudes en el popup
  function renderPendingRequests(data) {
    const vacacionesSection = document.getElementById('vacacionesSection');
    const bajasSection = document.getElementById('bajasSection');
    const ausenciasSection = document.getElementById('ausenciasSection');
    const noRequestsMessage = document.getElementById('noRequestsMessage');

    // Ocultar mensaje de "sin solicitudes"
    noRequestsMessage.classList.add('hidden');

    // Renderizar Vacaciones
    if (data.vacaciones.length > 0) {
      document.getElementById('vacacionesCount').textContent = data.vacaciones.length;
      document.getElementById('vacacionesList').innerHTML = data.vacaciones.map(req => createRequestCard(req, '#3B82F6')).join('');
      vacacionesSection.classList.remove('hidden');
    } else {
      vacacionesSection.classList.add('hidden');
    }

    // Renderizar Bajas
    if (data.bajas.length > 0) {
      document.getElementById('bajasCount').textContent = data.bajas.length;
      document.getElementById('bajasList').innerHTML = data.bajas.map(req => createRequestCard(req, '#EF4444')).join('');
      bajasSection.classList.remove('hidden');
    } else {
      bajasSection.classList.add('hidden');
    }

    // Renderizar Ausencias
    if (data.ausencias.length > 0) {
      document.getElementById('ausenciasCount').textContent = data.ausencias.length;
      document.getElementById('ausenciasList').innerHTML = data.ausencias.map(req => createRequestCard(req, '#F59E0B')).join('');
      ausenciasSection.classList.remove('hidden');
    } else {
      ausenciasSection.classList.add('hidden');
    }
  }

  // Crear tarjeta de solicitud
  function createRequestCard(req, borderColor) {
    return `
      <div class="p-4 rounded-lg border-l-4 transition-all hover:shadow-lg" style="background-color: var(--bg-secondary); border-left-color: ${borderColor};">
        <div class="flex justify-between items-start mb-2">
          <h5 class="font-semibold" style="color: var(--text-primary);">${req.employee_name}</h5>
          <span class="text-xs px-2 py-1 rounded" style="background-color: var(--bg-hover); color: var(--text-muted);">${req.status}</span>
        </div>
        <div class="text-sm space-y-1" style="color: var(--text-secondary);">
          <p><strong style="color: var(--text-primary);">Fechas:</strong> ${req.start_date} - ${req.end_date} (${req.days_count} d√≠a${req.days_count > 1 ? 's' : ''})</p>
          <p><strong style="color: var(--text-primary);">Motivo:</strong> ${req.reason}</p>
          <p class="text-xs" style="color: var(--text-muted);">Solicitado: ${req.created_at}</p>
          ${req.has_attachment ? '<p class="text-xs font-semibold" style="color: var(--accent-primary);">üìé Tiene adjunto</p>' : ''}
        </div>
      </div>
    `;
  }

  // Mostrar popup si es necesario
  async function showPopupIfNeeded() {
    // Verificar si se debe mostrar
    const hideUntil = localStorage.getItem('hidePendingRequestsUntil');
    const today = new Date().toDateString();

    // Si el usuario dijo "no mostrar hasta ma√±ana" y a√∫n no es ma√±ana
    if (hideUntil && new Date(hideUntil).toDateString() === today) {
      return;
    }

    // Si ya se vio en esta sesi√≥n
    if (sessionStorage.getItem('pendingRequestsPopupSeen') === 'true') {
      return;
    }

    // Cargar solicitudes
    const count = await loadPendingRequests();

    if (count > 0) {
      pendingRequestsPopup.classList.remove('hidden');
      markPopupAsSeen();
    }
  }

  // Marcar popup como visto en esta sesi√≥n
  function markPopupAsSeen() {
    sessionStorage.setItem('pendingRequestsPopupSeen', 'true');
  }

  // Cerrar popup
  function closePendingRequestsPopup() {
    pendingRequestsPopup.classList.add('hidden');
  }

  // No mostrar hasta ma√±ana
  function hidePopupUntilTomorrow() {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(0, 0, 0, 0);
    localStorage.setItem('hidePendingRequestsUntil', tomorrow.toISOString());
    closePendingRequestsPopup();
  }

  // Hacer funciones globales para que funcionen con onclick
  window.closePendingRequestsPopup = closePendingRequestsPopup;
  window.hidePopupUntilTomorrow = hidePopupUntilTomorrow;

  // Mostrar popup autom√°ticamente al cargar la p√°gina
  window.addEventListener('load', () => {
    setTimeout(showPopupIfNeeded, 1000); // Esperar 1 segundo para que cargue todo
  });

  // === FUNCIONES DE APROBACI√ìN/RECHAZO DE SOLICITUDES ===

  // Aprobar solicitud
  async function approveRequest(requestId) {
    if (!confirm('¬øEst√°s seguro de que deseas APROBAR esta solicitud?')) return;

    try {
      const response = await fetch(`/admin/leave_requests/approve/${requestId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      });

      const data = await response.json();

      if (response.ok && data.success !== false) {
        alert('Solicitud aprobada correctamente');
        // Recargar notificaciones
        loadNotifications();
        // Actualizar badge
        loadNotificationCount();
      } else {
        alert('Error al aprobar: ' + (data.error || 'Error desconocido'));
      }
    } catch (error) {
      console.error('Error al aprobar solicitud:', error);
      alert('Error al aprobar la solicitud');
    }
  }

  // Rechazar solicitud
  async function rejectRequest(requestId) {
    const reason = prompt('¬øPor qu√© rechazas esta solicitud? (opcional)');
    if (reason === null) return; // Usuario cancel√≥

    try {
      const response = await fetch(`/admin/leave_requests/reject/${requestId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ reason: reason })
      });

      const data = await response.json();

      if (response.ok && data.success !== false) {
        alert('Solicitud rechazada correctamente');
        // Recargar notificaciones
        loadNotifications();
        // Actualizar badge
        loadNotificationCount();
      } else {
        alert('Error al rechazar: ' + (data.error || 'Error desconocido'));
      }
    } catch (error) {
      console.error('Error al rechazar solicitud:', error);
      alert('Error al rechazar la solicitud');
    }
  }

  // Hacer funciones globales
  window.approveRequest = approveRequest;
  window.rejectRequest = rejectRequest;

  // === CIERRE MANUAL DE REGISTROS ===

  // Cerrar todos los registros abiertos manualmente
  async function manualCloseRecords() {
    if (!confirm('¬øEst√°s seguro de que deseas cerrar TODOS los registros abiertos de HOY? Esta acci√≥n no se puede deshacer.')) {
      return;
    }

    try {
      const response = await fetch('/admin/manual-close-records', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      });

      const data = await response.json();

      if (response.ok && data.success) {
        alert(`‚úì Se han cerrado ${data.closed_count} registro(s) abierto(s)`);
        // Recargar la p√°gina para reflejar los cambios
        location.reload();
      } else {
        alert('Error al cerrar registros: ' + (data.error || 'Error desconocido'));
      }
    } catch (error) {
      console.error('Error al cerrar registros:', error);
      alert('Error al cerrar los registros');
    }
  }

  // Hacer funci√≥n global
  window.manualCloseRecords = manualCloseRecords;
</script>

{% endblock %}
