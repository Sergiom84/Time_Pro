<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Fichaje Laboral{% endblock %}</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">

  <!-- Sistema de Temas CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/themes.css') }}">

  <!-- Socket.IO para sincronizaci√≥n en tiempo real -->
  <!-- Socket.IO eliminado: el tema se cambia v√≠a HTTP -->

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            sushi: {
              50:  '#fff5fa',
              100: '#ffe8f3',
              200: '#ffc6e0',
              300: '#ffa4cc',
              400: '#ff82b9',
              500: '#ff5fa5',
              600: '#ff4f9d',
              700: '#e03b86',
              800: '#be2e6d',
              900: '#9c2559'
            }
          },
          fontFamily: {
            brand: ['"Montserrat"', 'sans-serif']
          }
        }
      }
    };
  </script>

  <script>
    // Shim m√≠nimo para Socket.IO: evita conexiones reales y errores
    window.io = window.io || function () {
      return {
        on: function () {},
        emit: function () {}
      };
    };
  </script>

  {% block extra_head %}{% endblock %}
  <style>
    .sidebar-link {
      display: block;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 500;
    }
    /* Alinear el borde superior de sidebar y topbar */
    #sidebar { margin-top: 0; }

    /* Animaci√≥n de pulso para notificaciones */
    @keyframes pulse-notification {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.15);
        opacity: 0.85;
      }
    }

    .notification-pulse {
      animation: pulse-notification 2s ease-in-out infinite;
    }

    /* Animaci√≥n para el popup de solicitudes */
    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .popup-slide-in {
      animation: slideInDown 0.4s ease-out;
    }
  </style>
</head>

<body data-theme="{{ current_theme }}" class="font-sans transition-all duration-300">
  <div class="flex min-h-screen">
    <style>
      /* Corrige salto visual entre sidebar y topbar en escritorio */
      @media (min-width: 768px) {
        #sidebar { position: sticky; top: 0; align-self: flex-start; }
      }
    </style>


    {% if session.get('is_admin') %}
    <!-- Overlay para cerrar sidebar en m√≥vil -->
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="hidden md:block md:flex flex-col w-56 bg-secondary text-primary flex-shrink-0 fixed md:static z-50 h-full md:h-auto border-r border-primary overflow-y-auto">
      <div class="px-6 py-3 font-brand text-xl text-center border-b border-primary text-primary">Men√∫</div>
      <nav class="mt-4 flex flex-col gap-1 px-2 flex-1">
        {% set links = [
          {'endpoint': 'admin.dashboard',    'label': 'Dashboard'},
          {'endpoint': 'admin.manage_users', 'label': 'Gestionar Usuarios'},
          {'endpoint': 'admin.manage_records','label': 'Gestionar Registros'},
          {'endpoint': 'admin.leave_requests','label': 'Gesti√≥n de Solicitudes'},
          {'endpoint': 'admin.admin_calendar',     'label': 'Calendario'},
          {'endpoint': 'export.export_excel',   'label': 'Exportar Excel'}
        ] %}
        {% for link in links %}
          {% set active = request.endpoint.startswith(link.endpoint) %}
          <a href="{{ url_for(link.endpoint) }}"
             class="sidebar-link {{ active and 'bg-accent-primary text-inverse' or 'text-primary hover:bg-hover hover:accent-primary' }}"
             aria-current="{{ active and 'page' or '' }}">
            {{ link.label }}
          </a>
        {% endfor %}
      </nav>

      <!-- Selector de Tema -->
      <div class="border-t border-primary mt-4 p-4">
        <h3 class="text-xs font-bold uppercase text-muted mb-3">Personalizaci√≥n</h3>

        <!-- Bot√≥n para abrir el selector de temas -->
        <button id="theme-toggle-btn" class="w-full px-4 py-2 rounded text-primary bg-hover border border-primary text-sm font-medium transition-all hover:opacity-90 flex items-center justify-between">
          <span>Cambiar Tema</span>
          <svg id="theme-arrow" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>

        <!-- Panel desplegable de temas (oculto por defecto) -->
        <div id="theme-dropdown" class="hidden mt-2 p-3 rounded bg-secondary border border-primary relative z-50 shadow-xl">
          <div class="theme-selector flex flex-col gap-3">
            <!-- Tema Oscuro Turquesa -->
            <div class="text-center cursor-pointer hover:opacity-80 transition-opacity" onclick="selectAndCloseTheme('dark-turquoise')">
              <div class="theme-option dark-turquoise {{ 'active' if current_theme == 'dark-turquoise' }}"
                   data-theme="dark-turquoise"
                   title="Tema Oscuro Turquesa"
                   style="margin: 0 auto;">
              </div>
              <span class="text-xs text-muted mt-1 block">Oscuro</span>
            </div>

            <!-- Tema Claro Minimalista -->
            <div class="text-center cursor-pointer hover:opacity-80 transition-opacity" onclick="selectAndCloseTheme('light-minimal')">
              <div class="theme-option light-minimal {{ 'active' if current_theme == 'light-minimal' }}"
                   data-theme="light-minimal"
                   title="Tema Claro Minimalista"
                   style="margin: 0 auto;">
              </div>
              <span class="text-xs text-muted mt-1 block">Claro</span>
            </div>

            <!-- Tema Gradiente Turquesa -->
            <div class="text-center cursor-pointer hover:opacity-80 transition-opacity" onclick="selectAndCloseTheme('turquoise-gradient')">
              <div class="theme-option turquoise-gradient {{ 'active' if current_theme == 'turquoise-gradient' }}"
                   data-theme="turquoise-gradient"
                   title="Tema Gradiente Turquesa"
                   style="margin: 0 auto;">
              </div>
              <span class="text-xs text-muted mt-1 block">Gradiente</span>
            </div>
          </div>
        </div>

        <p class="text-xs text-muted mt-3 text-center">
          Tema actual: <span id="current-theme-label" class="text-primary font-bold">
            {% if current_theme == 'dark-turquoise' %}Oscuro
            {% elif current_theme == 'light-minimal' %}Claro
            {% else %}Gradiente{% endif %}
          </span>
        </p>
      </div>
    </aside>
    {% endif %}

    <!-- Contenido principal -->
    <!-- Quitamos md:ml-56 para que en escritorio no haya hueco artificial junto a la sidebar -->
    <div class="flex-1 flex flex-col ml-0 transition-all duration-300 ease-in-out">

      <!-- Topbar -->
      <header class="bg-secondary px-4 py-3 border-b border-primary flex items-center justify-between shadow-md">
        <div class="flex items-center gap-4">
          {% if session.get('is_admin') %}
          <!-- Bot√≥n hamburguesa solo en m√≥vil -->
          <button id="btn-sidebar-toggle" class="md:hidden text-sushi-500 hover:text-sushi-300 focus:outline-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
                 stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
          {% endif %}
          <h1 class="text-2xl font-semibold font-brand text-primary">
            {% block header %}{% endblock %}
          </h1>
        </div>

        <div class="flex items-center gap-4">
          <!-- Mostrar el centro del admin o su rol -->
          {% if session.get('admin_centro') %}
            <span class="px-3 py-1 rounded-full text-xs font-semibold text-white shadow-sm"
                  style="background-color: var(--accent-primary);">
              {{ session.get('admin_centro') }}
            </span>
          {% endif %}
          {% if greeting %}
            <span class="text-primary font-medium text-sm">
              {{ greeting }}
            </span>
          {% endif %}
          {% if session.get('is_admin') %}
            <!-- Bot√≥n de Notificaciones -->
            <button type="button" id="headerNotificationsBtn" class="relative p-2 rounded-full transition-all hover:opacity-80" style="background-color: var(--accent-primary);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
              </svg>
              <span id="headerNotificationBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
            </button>
          {% endif %}
          <a href="{{ url_for('auth.logout') }}" class="text-sushi-600 hover:text-sushi-500 font-medium text-sm">
            Cerrar Sesi√≥n
          </a>
        </div>
      </header>

      {% block flashes %}
      <!-- Flash messages (global) -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div id="global-flashes" class="px-4 pt-3">
            {% for category, message in messages %}
              <div class="mb-3 p-3 rounded text-sm border transition-opacity duration-500
                          {% if category == 'danger' %} bg-red-900 text-red-200 border-red-700
                          {% elif category == 'success' %} bg-green-900 text-green-200 border-green-700
                          {% elif category == 'warning' %} bg-yellow-900 text-yellow-200 border-yellow-700
                          {% else %} bg-blue-900 text-blue-200 border-blue-700 {% endif %}">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
      {% endblock %}

      <main class="flex-1 p-2 overflow-auto">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <script>
    // Toggle sidebar en m√≥vil
    const btnSidebar = document.getElementById('btn-sidebar-toggle');
    const sidebarOverlay = document.getElementById('sidebar-overlay');

    if (btnSidebar) {
      const aside = document.getElementById('sidebar');

      // Abrir/cerrar sidebar con bot√≥n hamburguesa
      btnSidebar.addEventListener('click', () => {
        aside.classList.toggle('hidden');
        if (sidebarOverlay) {
          sidebarOverlay.classList.toggle('hidden');
        }
      });

      // Cerrar sidebar al hacer click en el overlay
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', () => {
          aside.classList.add('hidden');
          sidebarOverlay.classList.add('hidden');
        });
      }
    }

    // Auto-desvanecido de flashes globales tras 2s
    const flashes = document.getElementById('global-flashes');
    if (flashes) {
      setTimeout(() => {
        flashes.style.transition = 'opacity 0.6s ease';
        flashes.style.opacity = '0';
        setTimeout(() => flashes.remove(), 800);
      }, 2000);
    }

    // Inicializar Socket.IO para sincronizaci√≥n de temas
    const socket = io();

    // Escuchar cambios de tema desde el servidor
    socket.on('theme_update', function(data) {
      const newTheme = data.theme;
      const body = document.body;

      // Aplicar animaci√≥n de transici√≥n
      body.classList.add('theme-changing');

      // Cambiar el tema
      body.setAttribute('data-theme', newTheme);

      // Remover animaci√≥n despu√©s de completarse
      setTimeout(() => {
        body.classList.remove('theme-changing');
      }, 600);

      // Si hay un selector de tema, actualizar su estado
      const themeOptions = document.querySelectorAll('.theme-option');
      themeOptions.forEach(option => {
        option.classList.remove('active');
        if (option.dataset.theme === newTheme) {
          option.classList.add('active');
        }
      });
    });

    // Funci√≥n para cambiar el tema (para el selector de temas)
    function changeTheme(themeName) {
      socket.emit('change_theme', { theme: themeName }, function(response) {
        if (!response.success) {
          console.error('Error cambiando tema:', response.message);
        }
      });
    }

    // Toggle del desplegable de temas
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const themeDropdown = document.getElementById('theme-dropdown');
    const themeArrow = document.getElementById('theme-arrow');

    if (themeToggleBtn && themeDropdown) {
      themeToggleBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const isHidden = themeDropdown.classList.contains('hidden');

        if (isHidden) {
          themeDropdown.classList.remove('hidden');
          themeArrow.style.transform = 'rotate(180deg)';
        } else {
          themeDropdown.classList.add('hidden');
          themeArrow.style.transform = 'rotate(0deg)';
        }
      });

      // Cerrar cuando se hace clic fuera
      document.addEventListener('click', function (event) {
        if (!themeDropdown.contains(event.target) && !themeToggleBtn.contains(event.target)) {
          themeDropdown.classList.add('hidden');
          themeArrow.style.transform = 'rotate(0deg)';
        }
      });
    }

    // Funci√≥n para seleccionar tema y cerrar el desplegable
    function selectAndCloseTheme(themeName) {
        // Cambiar el tema
        changeTheme(themeName);
        document.body.setAttribute('data-theme', themeName);

      // Actualizar la etiqueta del tema actual
      const currentThemeLabel = document.getElementById('current-theme-label');
      if (currentThemeLabel) {
        const themeNames = {
          'dark-turquoise': 'Oscuro',
          'light-minimal': 'Claro',
          'turquoise-gradient': 'Gradiente'
        };
        currentThemeLabel.textContent = themeNames[themeName] || themeName;
      }

      // Cerrar el desplegable
      if (themeDropdown && themeArrow) {
        themeDropdown.classList.add('hidden');
        themeArrow.style.transform = 'rotate(0deg)';
      }
    }

    {% if session.get('is_admin') %}
    // === SISTEMA DE NOTIFICACIONES ===

    const notificationsBtn = document.getElementById('headerNotificationsBtn');
    const notificationBadge = document.getElementById('headerNotificationBadge');
    let notificationsSeen = false;

    // Abrir modal de notificaciones
    if (notificationsBtn) {
      notificationsBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const notificationsModal = document.getElementById('notificationsModal');
        if (notificationsModal) {
          notificationsModal.classList.remove('hidden');
          loadNotifications();
          // Marcar notificaciones como vistas y ocultar el badge
          notificationsSeen = true;
          if (notificationBadge) {
            notificationBadge.classList.add('hidden');
            notificationBadge.classList.remove('notification-pulse');
          }
        }
      });
    }

    // Cerrar modal
    function closeNotificationsModal() {
      const notificationsModal = document.getElementById('notificationsModal');
      if (notificationsModal) {
        notificationsModal.classList.add('hidden');
      }
    }

    // Cargar notificaciones
    async function loadNotifications() {
      try {
        // Cargar SOLO solicitudes pendientes
        const response = await fetch('/admin/notifications/pending-requests');
        const pendingData = await response.json();

        const notificationsList = document.getElementById('notificationsList');

        // Funci√≥n auxiliar para crear HTML de notificaci√≥n con botones de acci√≥n
        function createNotificationHTML(notif) {
          const typeColors = {
            'Vacaciones': '#3B82F6',
            'Baja m√©dica': '#EF4444',
            'Ausencia justificada': '#F59E0B',
            'Ausencia injustificada': '#DC2626',
            'Permiso especial': '#8B5CF6'
          };
          const color = typeColors[notif.request_type] || '#6B7280';

          return `
            <div class="p-5 rounded-lg mb-4 border-l-4" style="background-color: var(--bg-secondary); border-left-color: ${color};">
              <!-- Cabecera con info del empleado -->
              <div class="flex justify-between items-start mb-3">
                <div>
                  <h4 class="font-bold text-lg" style="color: var(--text-primary);">${notif.employee_name}</h4>
                  <span class="text-xs px-2 py-1 rounded-full text-white mt-1 inline-block" style="background-color: ${color};">
                    ${notif.request_type}
                  </span>
                </div>
                <span class="text-xs" style="color: var(--text-muted);">${notif.created_at}</span>
              </div>

              <!-- Info de la solicitud -->
              <div class="grid grid-cols-2 gap-2 text-sm mb-3 p-3 rounded" style="background-color: var(--bg-primary);">
                <p style="color: var(--text-secondary);"><strong style="color: var(--text-primary);">Desde:</strong> ${notif.start_date}</p>
                <p style="color: var(--text-secondary);"><strong style="color: var(--text-primary);">Hasta:</strong> ${notif.end_date}</p>
                <p style="color: var(--text-secondary);" class="col-span-2"><strong style="color: var(--text-primary);">D√≠as:</strong> ${notif.days_count} d√≠a${notif.days_count > 1 ? 's' : ''}</p>
              </div>

              <!-- Motivo -->
              ${notif.reason ? `
                <div class="mb-3 p-3 rounded" style="background-color: var(--bg-primary);">
                  <p class="text-sm" style="color: var(--text-secondary);">
                    <strong style="color: var(--accent-primary);">Motivo:</strong> ${notif.reason}
                  </p>
                </div>
              ` : ''}

              <!-- Adjunto (si existe) -->
              ${notif.has_attachment ? `
                <div class="mb-3">
                  <button onclick="viewNotificationAttachment('${notif.attachment_url}', '${notif.attachment_filename}', 'application/pdf')"
                          class="text-sm px-3 py-2 rounded transition-all hover:opacity-80 inline-flex items-center gap-2"
                          style="background-color: var(--accent-primary); color: white;">
                    üìé Ver Justificante
                  </button>
                </div>
              ` : ''}

              <!-- Botones de Acci√≥n -->
              <div class="flex gap-2 mt-4">
                <button onclick="approveRequest(${notif.id})"
                        class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all hover:opacity-90"
                        style="background-color: #10B981; color: white;">
                  ‚úì Aprobar
                </button>
                <button onclick="rejectRequest(${notif.id})"
                        class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all hover:opacity-90"
                        style="background-color: #EF4444; color: white;">
                  ‚úó Rechazar
                </button>
                <button onclick="closeNotificationsModal()"
                        class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all hover:opacity-90"
                        style="background-color: var(--bg-hover); color: var(--text-primary); border: 1px solid var(--border-color);">
                  ‚è± M√°s tarde
                </button>
              </div>
            </div>
          `;
        }

        // Recolectar todas las solicitudes pendientes
        let allRequests = [];

        if (pendingData.success) {
          // Vacaciones pendientes
          if (pendingData.vacaciones && pendingData.vacaciones.length > 0) {
            allRequests = allRequests.concat(pendingData.vacaciones);
          }
          // Bajas pendientes
          if (pendingData.bajas && pendingData.bajas.length > 0) {
            allRequests = allRequests.concat(pendingData.bajas);
          }
          // Ausencias pendientes
          if (pendingData.ausencias && pendingData.ausencias.length > 0) {
            allRequests = allRequests.concat(pendingData.ausencias);
          }
        }

        // Ordenar por fecha: m√°s recientes primero
        allRequests.sort((a, b) => {
          const dateA = new Date(a.created_at.split('/').reverse().join('-') + ' ' + a.created_at.split(' ')[1]);
          const dateB = new Date(b.created_at.split('/').reverse().join('-') + ' ' + b.created_at.split(' ')[1]);
          return dateB - dateA; // Descendente (m√°s recientes primero)
        });

        // Mostrar todas las solicitudes pendientes
        if (allRequests.length > 0) {
          notificationsList.innerHTML = allRequests.map(req => createNotificationHTML(req)).join('');
        } else {
          notificationsList.innerHTML = `
            <div class="text-center py-8" style="color: var(--text-secondary);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <p>No hay notificaciones recientes</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error al cargar notificaciones:', error);
        const notificationsList = document.getElementById('notificationsList');
        if (notificationsList) {
          notificationsList.innerHTML = `
            <div class="text-center py-8 text-red-500">
              <p>Error al cargar las notificaciones</p>
            </div>
          `;
        }
      }
    }

    // Actualizar badge de notificaciones
    function updateNotificationBadge(count) {
      // Solo mostrar badge si hay notificaciones y el usuario no las ha visto a√∫n
      if (count > 0 && !notificationsSeen) {
        if (notificationBadge) {
          notificationBadge.textContent = count > 9 ? '9+' : count;
          notificationBadge.classList.remove('hidden');
          // A√±adir animaci√≥n de pulso
          notificationBadge.classList.add('notification-pulse');
        }
      } else {
        if (notificationBadge) {
          notificationBadge.classList.add('hidden');
          notificationBadge.classList.remove('notification-pulse');
        }
      }
    }

    // Cargar contador de notificaciones al cargar la p√°gina
    async function loadNotificationCount() {
      try {
        // Obtener SOLO solicitudes pendientes (no auto-aprobadas)
        const response = await fetch('/admin/notifications/pending-requests');
        const pendingData = await response.json();

        let totalCount = 0;

        // Contar solo solicitudes pendientes
        if (pendingData.success) {
          totalCount = pendingData.total;
        }

        updateNotificationBadge(totalCount);
      } catch (error) {
        console.error('Error al cargar contador de notificaciones:', error);
      }
    }

    // Cargar al iniciar
    window.addEventListener('load', loadNotificationCount);

    // Actualizar cada 60 segundos (solo si no han sido vistas)
    setInterval(() => {
      if (!notificationsSeen) {
        loadNotificationCount();
      }
    }, 60000);

    // Funci√≥n para visualizar adjuntos desde notificaciones
    function viewNotificationAttachment(url, filename, mimeType) {
      // Crear modal si no existe
      let modal = document.getElementById('attachmentModalNotif');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'attachmentModalNotif';
        modal.className = 'hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
          <div class="rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto" style="background-color: var(--bg-card); border: 2px solid var(--border-color); box-shadow: var(--shadow-lg);">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold" style="color: var(--accent-primary);">Justificante</h3>
              <button onclick="document.getElementById('attachmentModalNotif').classList.add('hidden')" class="text-2xl hover:opacity-70" style="color: var(--text-primary);">&times;</button>
            </div>
            <div id="attachmentContentNotif" class="text-center"></div>
            <div class="flex gap-3 mt-6">
              <a id="downloadLinkNotif" href="#" download class="flex-1 px-6 py-3 rounded-full font-semibold text-center transition-all hover:opacity-80" style="background-color: var(--accent-primary); color: white;">
                ‚¨áÔ∏è Descargar
              </a>
              <button onclick="document.getElementById('attachmentModalNotif').classList.add('hidden')" class="flex-1 px-6 py-3 rounded-full font-semibold transition-all hover:opacity-80" style="background-color: var(--bg-secondary); color: var(--text-primary); border: 2px solid var(--border-color);">
                Cerrar
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      const content = document.getElementById('attachmentContentNotif');
      const downloadLink = document.getElementById('downloadLinkNotif');

      // Configurar descarga
      downloadLink.href = url;
      downloadLink.download = filename;

      // Mostrar contenido
      if (mimeType && mimeType.includes('pdf')) {
        content.innerHTML = `<embed src="${url}" type="application/pdf" width="100%" height="600px" class="rounded-lg" />`;
      } else if (mimeType && mimeType.includes('image')) {
        content.innerHTML = `<img src="${url}" alt="${filename}" class="max-w-full max-h-[600px] mx-auto rounded-lg shadow-lg" />`;
      } else {
        content.innerHTML = `
          <div class="text-gray-400">
            <p>Archivo: <strong style="color: var(--text-primary);">${filename}</strong></p>
            <p class="mt-4">Usa el bot√≥n "Descargar" para ver el archivo</p>
          </div>
        `;
      }

      modal.classList.remove('hidden');
    }

    // Aprobar solicitud
    async function approveRequest(requestId) {
      if (!confirm('¬øEst√°s seguro de que deseas APROBAR esta solicitud?')) return;

      try {
        const response = await fetch(`/admin/leave_requests/approve/${requestId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        });

        const data = await response.json();

        if (response.ok && data.success !== false) {
          alert('Solicitud aprobada correctamente');
          // Recargar notificaciones
          loadNotifications();
          // Actualizar badge
          loadNotificationCount();
        } else {
          alert('Error al aprobar: ' + (data.error || 'Error desconocido'));
        }
      } catch (error) {
        console.error('Error al aprobar solicitud:', error);
        alert('Error al aprobar la solicitud');
      }
    }

    // Rechazar solicitud
    async function rejectRequest(requestId) {
      const reason = prompt('¬øPor qu√© rechazas esta solicitud? (opcional)');
      if (reason === null) return; // Usuario cancel√≥

      try {
        const response = await fetch(`/admin/leave_requests/reject/${requestId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ reason: reason })
        });

        const data = await response.json();

        if (response.ok && data.success !== false) {
          alert('Solicitud rechazada correctamente');
          // Recargar notificaciones
          loadNotifications();
          // Actualizar badge
          loadNotificationCount();
        } else {
          alert('Error al rechazar: ' + (data.error || 'Error desconocido'));
        }
      } catch (error) {
        console.error('Error al rechazar solicitud:', error);
        alert('Error al rechazar la solicitud');
      }
    }

    // Hacer funciones globales
    window.closeNotificationsModal = closeNotificationsModal;
    window.viewNotificationAttachment = viewNotificationAttachment;
    window.approveRequest = approveRequest;
    window.rejectRequest = rejectRequest;
    {% endif %}
  </script>

  <!-- Modal de Notificaciones (solo para admins) -->
  {% if session.get('is_admin') %}
  <div id="notificationsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="rounded-2xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto" style="background-color: var(--bg-card); border: 2px solid var(--border-color); box-shadow: var(--shadow-lg);">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold" style="color: var(--accent-primary);">Notificaciones de Bajas y Ausencias</h3>
        <button onclick="closeNotificationsModal()" class="text-2xl hover:opacity-70" style="color: var(--text-primary);">&times;</button>
      </div>

      <div id="notificationsList" class="space-y-3">
        <!-- Las notificaciones se cargar√°n din√°micamente aqu√≠ -->
      </div>
    </div>
  </div>
  {% endif %}
</body>
</html>
